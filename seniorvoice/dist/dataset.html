<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SeniorVoice ‚Äî Dataset Recorder</title>
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue-deep: #1a3a6b; --blue-mid: #2563eb; --blue-light: #dbeafe;
      --green: #15803d; --green-light: #dcfce7;
      --red: #dc2626; --red-light: #fee2e2;
      --orange: #d97706; --orange-light: #fef3c7;
      --warm-white: #fafbff; --card: #ffffff;
      --text: #0f172a; --text-muted: #64748b; --border: #e2e8f0;
    }
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    html { font-size: 17px; }
    body { font-family:'Source Sans 3', sans-serif; background:var(--warm-white); color:var(--text); min-height:100vh; padding:24px 16px 48px; max-width:800px; margin:0 auto; }
    h1 { font-family:'Lora', serif; color:var(--blue-deep); margin-bottom:6px; font-size:1.8rem; }
    .subtitle { color:var(--text-muted); margin-bottom:24px; font-size:1rem; }

    /* Progress */
    .progress-wrap { margin-bottom:20px; }
    .progress-label { font-weight:700; color:var(--blue-deep); margin-bottom:8px; font-size:1.05rem; }
    .progress-bar { background:var(--blue-light); border-radius:999px; height:14px; overflow:hidden; }
    .progress-fill { height:100%; background:linear-gradient(90deg, var(--blue-mid), var(--blue-deep)); border-radius:999px; transition:width 0.4s ease; }

    /* Prompt card */
    .prompt-card { background:var(--card); border-radius:20px; padding:28px 24px; box-shadow:0 4px 16px rgba(15,23,42,0.08); margin-bottom:20px; text-align:center; }
    .prompt-id { font-size:0.8rem; color:var(--text-muted); margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; }
    .prompt-text { font-size:1.5rem; font-weight:600; color:var(--text); line-height:1.6; margin-bottom:16px; word-break:break-word; }
    .prompt-text.rtl { direction:rtl; text-align:right; }
    .prompt-hint { font-size:0.9rem; color:var(--orange); background:var(--orange-light); padding:8px 14px; border-radius:8px; margin-bottom:14px; display:inline-block; }
    .prompt-meta { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
    .tag { display:inline-block; padding:4px 14px; border-radius:999px; font-size:0.78rem; font-weight:700; text-transform:uppercase; letter-spacing:0.05em; }
    .tag-action { background:var(--blue-light); color:#1e40af; }
    .tag-lang-FR { background:#dcfce7; color:#15803d; }
    .tag-lang-AR { background:#fef3c7; color:#92400e; }
    .tag-lang-MIXED { background:#f3e8ff; color:#6b21a8; }

    /* Buttons */
    .btn-row { display:flex; gap:12px; justify-content:center; margin-bottom:24px; flex-wrap:wrap; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; min-height:56px; padding:14px 28px; border:none; border-radius:12px; font-family:'Source Sans 3', sans-serif; font-size:1.05rem; font-weight:700; cursor:pointer; transition:all 0.2s ease; }
    .btn:active { transform:scale(0.96); }
    .btn-record { background:linear-gradient(145deg, var(--blue-mid), var(--blue-deep)); color:#fff; min-width:180px; }
    .btn-record:hover { box-shadow:0 6px 24px rgba(37,99,235,0.35); }
    .btn-record.recording { background:linear-gradient(145deg, var(--red), #b91c1c); }
    .btn-skip { background:var(--blue-light); color:var(--blue-deep); }
    .btn-export { background:var(--green); color:#fff; min-width:180px; }
    .btn-export:hover { background:#16a34a; }
    .btn-import { background:var(--orange-light); color:var(--orange); border:2px solid var(--orange); }
    .btn-reset { background:var(--red-light); color:var(--red); border:2px solid var(--red); }

    /* Status */
    .status-bar { text-align:center; padding:10px; font-size:0.95rem; color:var(--text-muted); margin-bottom:16px; min-height:36px; }
    .status-bar.recording { color:var(--red); font-weight:700; }
    .status-bar.done { color:var(--green); font-weight:700; }

    /* Done banner */
    .done-banner { text-align:center; padding:40px; background:var(--green-light); border-radius:20px; margin-bottom:24px; display:none; }
    .done-banner h2 { font-family:'Lora', serif; color:var(--green); font-size:1.6rem; margin-bottom:8px; }

    /* Table */
    .table-section { margin-top:32px; }
    .table-section h2 { font-family:'Lora', serif; color:var(--blue-deep); margin-bottom:14px; font-size:1.2rem; }
    .table-wrap { overflow-x:auto; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    table { width:100%; border-collapse:collapse; font-size:0.85rem; }
    th, td { padding:10px 14px; text-align:left; border-bottom:1px solid var(--blue-light); }
    th { background:var(--blue-light); color:var(--blue-deep); font-weight:700; position:sticky; top:0; }
    td { background:var(--card); }
    td.rtl { direction:rtl; text-align:right; }
    .rec-yes { color:var(--green); font-weight:700; }
    .rec-no  { color:var(--text-muted); }

    @media(max-width:500px) {
      html { font-size:15px; }
      .prompt-text { font-size:1.25rem; }
      .btn { min-height:50px; padding:12px 18px; }
    }
  </style>
</head>
<body>

  <h1>üéôÔ∏è SeniorVoice ‚Äî Dataset</h1>
  <p class="subtitle">Enregistrez les 50 √©chantillons vocaux pour le dataset annot√©</p>

  <div class="progress-wrap">
    <div class="progress-label" id="progress-label">0 / 50 enregistr√©s</div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
  </div>

  <div class="done-banner" id="done-banner">
    <h2>üéâ Dataset complet !</h2>
    <p>Tous les 50 √©chantillons ont √©t√© enregistr√©s. Exportez le JSON ci-dessous.</p>
  </div>

  <div id="recorder-section">
    <div class="prompt-card" id="prompt-card">
      <div class="prompt-id" id="prompt-id">Prompt 1 / 50</div>
      <div class="prompt-text" id="prompt-text"></div>
      <div class="prompt-hint" id="prompt-hint"></div>
      <div class="prompt-meta">
        <span class="tag tag-action" id="tag-action"></span>
        <span class="tag" id="tag-lang"></span>
      </div>
    </div>

    <div class="status-bar" id="status-bar">Appuyez sur Enregistrer pour commencer</div>

    <div class="btn-row">
      <button class="btn btn-record" id="btn-record">üéôÔ∏è Enregistrer</button>
      <button class="btn btn-skip" id="btn-skip">‚è≠Ô∏è Passer</button>
    </div>
  </div>

  <div class="btn-row">
    <button class="btn btn-export" id="btn-export">üì• Exporter JSON</button>
    <label class="btn btn-import" style="cursor:pointer;">
      üì§ Importer JSON
      <input type="file" id="import-file" accept=".json" style="display:none">
    </label>
    <button class="btn btn-reset" id="btn-reset">üóëÔ∏è R√©initialiser</button>
  </div>

  <div class="table-section">
    <h2>üìã √âchantillons enregistr√©s</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Texte</th>
            <th>Action</th>
            <th>Langue</th>
            <th>Statut</th>
            <th>Heure</th>
          </tr>
        </thead>
        <tbody id="samples-table"></tbody>
      </table>
    </div>
  </div>

  <script>
  'use strict';

  /* ‚îÄ‚îÄ 50 Prompts ‚îÄ‚îÄ */
  const PROMPTS = [
    // REMINDERS (10)
    { id:1,  text:"Euh‚Ä¶ rappelle-moi‚Ä¶ demain matin‚Ä¶ le docteur‚Ä¶ √† 10h", action:"reminder", lang:"FR", hint:"H√©sitez, parlez lentement" },
    { id:2,  text:"ŸÅŸÉŸëÿ±ŸÜŸä‚Ä¶ ÿ®ŸÉÿ±ÿ©‚Ä¶ ÿπŸÜÿØ ÿßŸÑÿØŸÉÿ™Ÿàÿ±‚Ä¶ ÿßŸÑÿ≥ÿßÿπÿ© ÿπÿ¥ÿ±ÿ©", action:"reminder", lang:"AR", hint:"Parlez en arabe dialectal tunisien" },
    { id:3,  text:"Rappelle-moi‚Ä¶ euh‚Ä¶ de prendre mon m√©dicament‚Ä¶ ce soir", action:"reminder", lang:"FR", hint:"Faites des pauses naturelles" },
    { id:4,  text:"ŸÅŸÉŸëÿ±ŸÜŸä ÿ®ÿßŸÑÿØŸàÿßÿ°‚Ä¶ ÿßŸÑŸÑŸäŸÑÿ©‚Ä¶ ŸÇÿ®ŸÑ ÿßŸÑŸÜŸàŸÖ", action:"reminder", lang:"AR", hint:"Voix douce, h√©sitante" },
    { id:5,  text:"Euh‚Ä¶ je veux‚Ä¶ un rappel pour‚Ä¶ mon rendez-vous‚Ä¶ vendredi", action:"reminder", lang:"FR", hint:"Cherchez vos mots" },
    { id:6,  text:"ŸÅŸÉŸëÿ±ŸÜŸä‚Ä¶ ÿ®ŸÉÿ±ÿ© ÿßŸÑÿµÿ®ÿ≠‚Ä¶ ŸÜÿ±Ÿàÿ≠ ŸÑŸÑÿØŸÉÿ™Ÿàÿ±", action:"reminder", lang:"AR", hint:"Parlez naturellement" },
    { id:7,  text:"Rappelle-moi‚Ä¶ euh‚Ä¶ de‚Ä¶ d'appeler Mohamed‚Ä¶ demain", action:"reminder", lang:"FR", hint:"H√©sitez sur le pr√©nom" },
    { id:8,  text:"Euh‚Ä¶ fais-moi un rappel‚Ä¶ pour‚Ä¶ le m√©dicament du midi", action:"reminder", lang:"FR", hint:"Parlez lentement" },
    { id:9,  text:"ŸÅŸÉŸëÿ±ŸÜŸä‚Ä¶ ÿßŸÑÿØŸàÿßÿ°‚Ä¶ ÿßŸÑÿ∏Ÿáÿ±‚Ä¶ ÿßŸÑŸäŸàŸÖ", action:"reminder", lang:"AR", hint:"Voix calme" },
    { id:10, text:"Rappelle-moi‚Ä¶ euh‚Ä¶ ce soir √†‚Ä¶ huit heures‚Ä¶ pour‚Ä¶ le d√Æner", action:"reminder", lang:"FR", hint:"Cherchez l'heure" },

    // CALLS (8)
    { id:11, text:"ÿπŸäŸëÿ∑ ÿπŸÑŸâ ŸàŸÑÿØŸä‚Ä¶ ŸÖÿ≠ŸÖÿØ", action:"call", lang:"AR", hint:"Voix urgente mais calme" },
    { id:12, text:"Appelle‚Ä¶ euh‚Ä¶ mon fils‚Ä¶ s'il te pla√Æt", action:"call", lang:"FR", hint:"H√©sitez sur 'fils'" },
    { id:13, text:"ÿπŸäŸëÿ∑ ÿπŸÑŸâ ÿ®ŸÜÿ™Ÿä‚Ä¶ ŸÅÿßÿ∑ŸÖÿ©", action:"call", lang:"AR", hint:"Parlez doucement" },
    { id:14, text:"Je veux‚Ä¶ appeler‚Ä¶ ma fille‚Ä¶ Fatma", action:"call", lang:"FR", hint:"Parlez lentement" },
    { id:15, text:"ÿπŸäŸëÿ∑ ÿπŸÑŸâ‚Ä¶ ÿ£ÿÆÿ™Ÿä‚Ä¶ ŸÅŸä ÿ™ŸàŸÜÿ≥", action:"call", lang:"AR", hint:"Voix naturelle" },
    { id:16, text:"Appelle‚Ä¶ euh‚Ä¶ le docteur‚Ä¶ Ben Ali", action:"call", lang:"FR", hint:"Cherchez le nom" },
    { id:17, text:"ÿπŸäŸëÿ∑ ÿπŸÑŸâ‚Ä¶ ÿßŸÑÿØŸÉÿ™Ÿàÿ±‚Ä¶ ÿ®ÿßŸÑÿπÿ¨ŸÑÿ©", action:"call", lang:"AR", hint:"Voix l√©g√®rement urgente" },
    { id:18, text:"Euh‚Ä¶ appelle‚Ä¶ mon fr√®re‚Ä¶ Ahmed‚Ä¶ s'il te pla√Æt", action:"call", lang:"FR", hint:"H√©sitez naturellement" },

    // WEATHER (5)
    { id:19, text:"Quelle est‚Ä¶ la m√©t√©o‚Ä¶ aujourd'hui‚Ä¶ √† Tunis ?", action:"weather", lang:"FR", hint:"Parlez lentement" },
    { id:20, text:"ŸÉŸäŸÅÿßÿ¥ ÿßŸÑÿ∑ŸÇÿ≥‚Ä¶ ÿßŸÑŸäŸàŸÖ ÿü", action:"weather", lang:"AR", hint:"Voix curieuse" },
    { id:21, text:"Il fait‚Ä¶ quel temps‚Ä¶ aujourd'hui ?", action:"weather", lang:"FR", hint:"H√©sitez" },
    { id:22, text:"Euh‚Ä¶ la m√©t√©o‚Ä¶ pour demain‚Ä¶ s'il te pla√Æt", action:"weather", lang:"FR", hint:"Parlez doucement" },
    { id:23, text:"ŸÉŸäŸÅÿßÿ¥ ÿßŸÑÿ¨Ÿà‚Ä¶ ÿ®ŸÉÿ±ÿ© ÿü", action:"weather", lang:"AR", hint:"Voix naturelle" },

    // MEDICATIONS (6)
    { id:24, text:"ŸÜÿ≥Ÿäÿ™ ÿßŸÑÿØŸàÿßÿ°‚Ä¶ ÿßŸÑÿµÿ®ÿ≠‚Ä¶ ŸáŸÑ ÿ£ÿÆÿ∞ÿ™Ÿá ÿü", action:"medication", lang:"AR", hint:"Voix incertaine" },
    { id:25, text:"J'ai pris‚Ä¶ mon m√©dicament‚Ä¶ ce matin", action:"medication", lang:"FR", hint:"Parlez avec confiance" },
    { id:26, text:"ÿ£ÿÆÿ∞ÿ™ ÿßŸÑÿØŸàÿßÿ°‚Ä¶ ÿßŸÑÿ∏Ÿáÿ±", action:"medication", lang:"AR", hint:"Voix calme" },
    { id:27, text:"Euh‚Ä¶ j'ai oubli√©‚Ä¶ mon m√©dicament‚Ä¶ du soir", action:"medication", lang:"FR", hint:"Voix inqui√®te" },
    { id:28, text:"ŸÜÿ≥Ÿäÿ™ ÿØŸàÿßÿ°‚Ä¶ ÿßŸÑŸÑŸäŸÑÿ©‚Ä¶ ÿßŸÑÿ£ŸÖŸÑŸàÿ±", action:"medication", lang:"AR", hint:"Mentionnez le nom du m√©dicament" },
    { id:29, text:"Quels m√©dicaments‚Ä¶ je dois prendre‚Ä¶ maintenant ?", action:"medication", lang:"FR", hint:"Voix interrogative" },

    // NEWS (5)
    { id:30, text:"Quelles sont‚Ä¶ les nouvelles‚Ä¶ aujourd'hui ?", action:"news", lang:"FR", hint:"Parlez lentement" },
    { id:31, text:"ÿ¥ŸÜŸàŸëÿ© ÿßŸÑÿ£ÿÆÿ®ÿßÿ±‚Ä¶ ÿßŸÑŸäŸàŸÖ ÿü", action:"news", lang:"AR", hint:"Voix curieuse" },
    { id:32, text:"Euh‚Ä¶ les actualit√©s‚Ä¶ tunisiennes‚Ä¶ s'il te pla√Æt", action:"news", lang:"FR", hint:"H√©sitez" },
    { id:33, text:"ÿ£ÿÆÿ®ÿßÿ± ÿ™ŸàŸÜÿ≥‚Ä¶ ÿßŸÑŸäŸàŸÖ", action:"news", lang:"AR", hint:"Voix naturelle" },
    { id:34, text:"Qu'est-ce qui se passe‚Ä¶ dans le monde‚Ä¶ aujourd'hui ?", action:"news", lang:"FR", hint:"Parlez doucement" },

    // MUSIC (5)
    { id:35, text:"Mets‚Ä¶ de la musique‚Ä¶ tunisienne‚Ä¶ s'il te pla√Æt", action:"music", lang:"FR", hint:"Voix d√©tendue" },
    { id:36, text:"ÿ≠ÿ∑ ŸÖŸàÿ≥ŸäŸÇŸâ‚Ä¶ ÿ™ŸàŸÜÿ≥Ÿäÿ©‚Ä¶ ŸáÿßÿØŸäÿ©", action:"music", lang:"AR", hint:"Voix calme" },
    { id:37, text:"Je veux‚Ä¶ √©couter‚Ä¶ de la musique‚Ä¶ relaxante", action:"music", lang:"FR", hint:"Parlez lentement" },
    { id:38, text:"Euh‚Ä¶ mets‚Ä¶ quelque chose‚Ä¶ de doux‚Ä¶ √† √©couter", action:"music", lang:"FR", hint:"Cherchez vos mots" },
    { id:39, text:"ÿ≠ÿ∑ ŸÖŸàÿ≥ŸäŸÇŸâ‚Ä¶ ŸÜÿ≥ŸÖÿπ", action:"music", lang:"AR", hint:"Voix naturelle" },

    // EMERGENCY (6)
    { id:40, text:"J'ai‚Ä¶ tr√®s mal‚Ä¶ au c≈ìur‚Ä¶ aide-moi", action:"emergency", lang:"FR", hint:"Voix douloureuse, urgente" },
    { id:41, text:"ÿπŸÜÿØŸä ÿ£ŸÑŸÖ‚Ä¶ ŸÅŸä ÿßŸÑÿµÿØÿ±‚Ä¶ ÿ®ÿßŸÑÿπÿ¨ŸÑÿ©", action:"emergency", lang:"AR", hint:"Voix urgente" },
    { id:42, text:"Je me sens‚Ä¶ tr√®s mal‚Ä¶ appelle‚Ä¶ les secours", action:"emergency", lang:"FR", hint:"Voix faible" },
    { id:43, text:"Euh‚Ä¶ j'ai‚Ä¶ du mal √†‚Ä¶ respirer‚Ä¶ aide", action:"emergency", lang:"FR", hint:"Voix essouffl√©e" },
    { id:44, text:"ÿπŸÜÿØŸä ÿØŸàÿÆÿ©‚Ä¶ ŸàŸÜŸÇÿπ‚Ä¶ ÿ®ÿßŸÑÿπÿ¨ŸÑÿ©", action:"emergency", lang:"AR", hint:"Voix urgente" },
    { id:45, text:"Appelle‚Ä¶ le‚Ä¶ cent quatre-vingt-dix‚Ä¶ vite", action:"emergency", lang:"FR", hint:"Voix urgente" },

    // SMART HOME (5)
    { id:46, text:"Allume‚Ä¶ la lumi√®re‚Ä¶ du salon‚Ä¶ s'il te pla√Æt", action:"smart_home", lang:"FR", hint:"Voix calme" },
    { id:47, text:"ŸàŸÇŸëÿØ ÿßŸÑÿ∂Ÿàÿ°‚Ä¶ ŸÅŸä ÿßŸÑÿµÿßŸÑŸàŸÜ", action:"smart_home", lang:"AR", hint:"Voix naturelle" },
    { id:48, text:"Euh‚Ä¶ √©teins‚Ä¶ la t√©l√©vision‚Ä¶ s'il te pla√Æt", action:"smart_home", lang:"FR", hint:"Parlez lentement" },
    { id:49, text:"ŸÅŸäŸë ÿßŸÑÿ™ŸÑŸÅÿ≤ÿ©‚Ä¶ ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ", action:"smart_home", lang:"AR", hint:"Voix calme" },
    { id:50, text:"Allume‚Ä¶ le climatiseur‚Ä¶ il fait chaud", action:"smart_home", lang:"FR", hint:"Voix d√©tendue" }
  ];

  /* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
  let currentIdx = 0;
  let samples = PROMPTS.map(p => ({ ...p, recorded: false, timestamp: null, audioBlob: null }));
  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;

  /* ‚îÄ‚îÄ DOM ‚îÄ‚îÄ */
  const $ = id => document.getElementById(id);

  function render() {
    const recorded = samples.filter(s => s.recorded).length;
    $('progress-label').textContent = recorded + ' / 50 enregistr√©s';
    $('progress-fill').style.width = (recorded / 50 * 100) + '%';

    if (recorded === 50) {
      $('done-banner').style.display = 'block';
      $('recorder-section').style.display = 'none';
    } else {
      $('done-banner').style.display = 'none';
      $('recorder-section').style.display = 'block';
      renderPrompt();
    }

    renderTable();
  }

  function renderPrompt() {
    // Find next unrecorded prompt starting from currentIdx
    let idx = currentIdx;
    while (idx < samples.length && samples[idx].recorded) idx++;
    if (idx >= samples.length) {
      // All done
      $('recorder-section').style.display = 'none';
      return;
    }
    currentIdx = idx;
    const s = samples[idx];
    $('prompt-id').textContent = 'Prompt ' + s.id + ' / 50';
    const textEl = $('prompt-text');
    textEl.textContent = s.text;
    textEl.className = 'prompt-text' + (s.lang === 'AR' ? ' rtl' : '');
    $('prompt-hint').textContent = 'üí° ' + s.hint;
    $('tag-action').textContent = s.action;
    const langEl = $('tag-lang');
    langEl.textContent = s.lang;
    langEl.className = 'tag tag-lang-' + s.lang;
    $('status-bar').textContent = 'Appuyez sur Enregistrer pour commencer';
    $('status-bar').className = 'status-bar';
    $('btn-record').textContent = 'üéôÔ∏è Enregistrer';
    $('btn-record').classList.remove('recording');
  }

  function renderTable() {
    const tbody = $('samples-table');
    tbody.innerHTML = samples.map(s => `
      <tr>
        <td>${s.id}</td>
        <td class="${s.lang === 'AR' ? 'rtl' : ''}">${escHtml(s.text)}</td>
        <td><span style="background:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:999px;font-size:0.75rem;font-weight:700">${s.action}</span></td>
        <td>${s.lang}</td>
        <td class="${s.recorded ? 'rec-yes' : 'rec-no'}">${s.recorded ? '‚úÖ Enregistr√©' : '‚≠ï En attente'}</td>
        <td>${s.timestamp ? new Date(s.timestamp).toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' }) : '‚Äî'}</td>
      </tr>`).join('');
  }

  function escHtml(t) {
    const d = document.createElement('div');
    d.textContent = t;
    return d.innerHTML;
  }

  /* ‚îÄ‚îÄ Recording ‚îÄ‚îÄ */
  $('btn-record').addEventListener('click', async () => {
    if (isRecording) {
      stopRecording();
    } else {
      await startRecording();
    }
  });

  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mimeType = ['audio/webm;codecs=opus','audio/webm','audio/ogg'].find(t => MediaRecorder.isTypeSupported(t)) || 'audio/webm';
      mediaRecorder = new MediaRecorder(stream, { mimeType });
      audioChunks = [];

      mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        stream.getTracks().forEach(t => t.stop());
        const blob = new Blob(audioChunks, { type: mimeType });
        samples[currentIdx].recorded = true;
        samples[currentIdx].timestamp = new Date().toISOString();
        samples[currentIdx].audioBlob = blob;
        $('status-bar').textContent = '‚úÖ Enregistr√© ! Passage au suivant‚Ä¶';
        $('status-bar').className = 'status-bar done';
        isRecording = false;
        $('btn-record').textContent = 'üéôÔ∏è Enregistrer';
        $('btn-record').classList.remove('recording');
        setTimeout(() => {
          currentIdx++;
          render();
        }, 1200);
      };

      mediaRecorder.start();
      isRecording = true;
      $('btn-record').textContent = '‚èπÔ∏è Arr√™ter';
      $('btn-record').classList.add('recording');
      $('status-bar').textContent = 'üî¥ Enregistrement en cours‚Ä¶ Parlez maintenant';
      $('status-bar').className = 'status-bar recording';
    } catch (e) {
      $('status-bar').textContent = '‚ùå Microphone inaccessible. V√©rifiez les permissions.';
      $('status-bar').className = 'status-bar';
    }
  }

  function stopRecording() {
    if (mediaRecorder?.state === 'recording') mediaRecorder.stop();
  }

  /* ‚îÄ‚îÄ Skip ‚îÄ‚îÄ */
  $('btn-skip').addEventListener('click', () => {
    if (isRecording) stopRecording();
    currentIdx++;
    if (currentIdx >= samples.length) currentIdx = 0;
    renderPrompt();
  });

  /* ‚îÄ‚îÄ Export ‚îÄ‚îÄ */
  $('btn-export').addEventListener('click', () => {
    const data = {
      exported_at: new Date().toISOString(),
      total: 50,
      recorded: samples.filter(s => s.recorded).length,
      samples: samples.map(s => ({
        id: s.id,
        text: s.text,
        action: s.action,
        lang: s.lang,
        hint: s.hint,
        recorded: s.recorded,
        timestamp: s.timestamp || null
      }))
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'seniorvoice-dataset-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  /* ‚îÄ‚îÄ Import ‚îÄ‚îÄ */
  $('import-file').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        if (data.samples && Array.isArray(data.samples)) {
          data.samples.forEach(imported => {
            const idx = samples.findIndex(s => s.id === imported.id);
            if (idx !== -1) {
              samples[idx].recorded = imported.recorded || false;
              samples[idx].timestamp = imported.timestamp || null;
            }
          });
          // Find first unrecorded
          currentIdx = samples.findIndex(s => !s.recorded);
          if (currentIdx === -1) currentIdx = 0;
          render();
          alert('Import r√©ussi ! ' + data.recorded + ' √©chantillons charg√©s.');
        }
      } catch (err) {
        alert('Erreur lors de l\'import : ' + err.message);
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  });

  /* ‚îÄ‚îÄ Reset ‚îÄ‚îÄ */
  $('btn-reset').addEventListener('click', () => {
    if (!confirm('R√©initialiser tous les enregistrements ?')) return;
    samples = PROMPTS.map(p => ({ ...p, recorded: false, timestamp: null, audioBlob: null }));
    currentIdx = 0;
    render();
  });

  /* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
  render();
  </script>
</body>
</html>
